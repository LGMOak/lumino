{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block content %}
<body>
    <!-- dynamic update the content -->
    <div class="chat"></div>

    <!-- Footer  -->
    <div class="footer">
        <div class="selection">
            <button id="scenario">Scenario</button>
        </div>
        <button id="mic-btn" class="btn btn-primary mic-btn-icon mx-2">
            <i class="bi bi-mic-fill"></i> Start
        </button>
        <button id="clearConversation">Clear</button>
    </div>
</body>

<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const micBtn = document.getElementById("mic-btn");
    const chatWindow = document.querySelector('.chat');
    let recognitionStarted = false;

    micBtn.addEventListener("click", function() {
        if (!recognitionStarted) {
            socket.emit('start_recognition');
            recognitionStarted = true;
            micBtn.textContent = 'Stop';
        } else {
            socket.emit('stop_recognition');
            recognitionStarted = false;
            micBtn.textContent = 'Start';
        }
    });

    socket.on('recognition_result', function(data) {
        if (data.recognized_text && data.translated_text) {
            const language = detectLanguage(data.recognized_text);
            addChatMessage(data.recognized_text, data.translated_text, language);
        }
    });

    socket.on('status', function(data) {
        console.log(data.status);
    });

    socket.on('error', function(data) {
        console.error(data.error);
    });

    function detectLanguage(text) {
        const hasChineseCharacters = /[\u3400-\u9FBF]/;
        return hasChineseCharacters.test(text) ? 'Chinese' : 'English';
    }

    function addChatMessage(recognizedText, translatedText, language) {
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message-container');

        const languageMessage = document.createElement('div');
        languageMessage.classList.add('message', 'language');
        languageMessage.textContent = language;

        const userMessage = document.createElement('div');
        userMessage.classList.add('message', 'user');
        userMessage.textContent = 'Recognized: ' + recognizedText;  

        messageContainer.appendChild(languageMessage);
        messageContainer.appendChild(userMessage);

        const botMessage = document.createElement('div');
        botMessage.classList.add('message', 'translation');
        botMessage.textContent = 'Translated: ' + translatedText;  

        messageContainer.appendChild(botMessage);

        chatWindow.appendChild(messageContainer);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    });

    // Clear function button 
        document.getElementById('clearConversation').addEventListener('click', function() {
        localStorage.removeItem('conversation');

        const chatContainer = document.querySelector('.chat');
        if (chatContainer) {
            chatContainer.innerHTML = '';  
        } else {
            console.error('Cannot find the chat Container');
        }
    });
</script>


{% endblock %}
