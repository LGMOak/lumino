{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block content %}
<body class="webUI">
    <!-- dynamic update the content -->
    <div class="chat"></div>

    <!-- Footer  -->
    <div class="footer">
        <div class="selection">
            <button id="scenario">Scenario</button>
        </div>
        <button id="mic-btn" class="btn btn-primary mic-btn-icon mx-2">
            <i class="bi bi-mic-fill"></i> Start
        </button>
        <button id="clearConversation">Clear</button>
    </div>
</body>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get references to critical elements
        const micBtn = document.getElementById("mic-btn");
        const chatWindow = document.querySelector('.chat'); // Assuming .chat is the class for your chat window container
    
        // Check if critical elements exist; log error and return if not
        if (!micBtn || !chatWindow) {
            console.error("Critical elements missing on the page!");
            return;
        }
    
        // Add click event listener to microphone button
        micBtn.addEventListener("click", function() {
            this.disabled = true; // Disable the mic button while processing
    
            console.log("Sending request to backend...");
    
            // Send POST request to '/translate' endpoint
            fetch('/translate', { method: 'POST' })
            .then(response => {
                console.log("Received response:", response);
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                return response.json(); // Parse response as JSON
            })
            .then(data => {
                console.log("Data received:", data);
                // Check if translation was successful
                if (data.success) {
                    console.log("Attempting to add messages to the chat window...");
                    // Add recognized and translated messages to the chat window
                    addChatMessage(data.recognized_text, data.translated_text);
                } else {
                    console.log("Data success flag is false or data missing important fields.");
                    // Add error message to chat window if translation fails
                    addChatMessage("Error", data.error || "No specific error message provided.");
                }
            })
            .catch(error => {
                console.error("Fetch error:", error);
                // Add fetch error message to chat window on error
                addChatMessage("Fetch error", error.message);
            })
            .finally(() => {
                this.disabled = false; // Re-enable mic button after request completes
            });
        });
    
        // Function to add messages to the chat window
        function addChatMessage(recognizedText, translatedText) {
            console.log("Adding messages: ", recognizedText, translatedText);
    
            // Create a div element for user message (recognized text)
            const userMessage = document.createElement('div');
            userMessage.classList.add('message', 'user'); // Add CSS classes 'message' and 'user' to style the message
            userMessage.textContent = 'Recognized: ' + recognizedText; // Display recognized text
    
            // Append user message to the chat window
            chatWindow.appendChild(userMessage);
    
            // Create a div element for bot message (translated text)
            const botMessage = document.createElement('div');
            botMessage.classList.add('message', 'computer'); // Add CSS classes 'message' and 'computer' for styling
            botMessage.textContent = 'Translated: ' + translatedText; // Display translated text
    
            // Append bot message to the chat window
            chatWindow.appendChild(botMessage);
    
            // Scroll chat window to the bottom to show latest messages
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    });
</script>
{% endblock %}


