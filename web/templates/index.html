{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block content %}
<body>

<!-- The top navigation bar include name and buttons -->
    <nav class="navbar navbar-expand-md">
        <a class="navbar-brand" href="{{ url_for('index')}}">Lumino</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="selection">
            <button id="scenario">Scenario</button>
            <div class="select_content" id="select_menu">
                <a href="#" data-value="Option 1">Medical Service</a>
                <a href="#" data-value="Option 2">Social Service</a>
                <a href="#" data-value="Option 3">Local Community</a>
                <a href="#" data-value="Option 4">General</a>
            </div>
        </div>
        <button id="mic-btn">
            <i class="bi bi-mic-fill"></i> 
            Start
        </button>
        <button id="clearConversation">Clear</button>
    </nav>

<form action="/" method="get">
    <label for="microphone">Select Microphone:</label>
    <select name="microphone" id="microphone" onchange="this.form.submit()">
        {% for mic in mics %}
        <option value="{{ mic }}" {% if mic == selected_microphone %}selected{% endif %}>{{ mics.get(mic) }}</option>
        {% endfor %}
    </select>
</form>

<form action="/" method="get">
    <!-- Keep the selected microphone in a hidden input -->
    <input type="hidden" name="microphone" value="{{ selected_microphone }}">
    <input type="hidden" name="lang" value="{{ 'CN' if language == 'EN' else 'EN' }}">
    <button type="submit">{{ 'Switch to Chinese' if language == 'EN' else 'Switch to English' }}</button>
</form>

    <!-- dynamic update the content -->
    <div class="chat"></div>

</body>

<!-- JavaScript -->
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
<script>

    // Start to record function 
    document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const micBtn = document.getElementById("mic-btn");
    const chatWindow = document.querySelector('.chat');
    let recognitionStarted = false;

    micBtn.addEventListener("click", function() {
        if (!recognitionStarted) {
            socket.emit('start_recognition');
            recognitionStarted = true;
            micBtn.textContent = 'Stop';
        } else {
            socket.emit('stop_recognition');
            recognitionStarted = false;
            micBtn.textContent = 'Start';
        }
    });

    socket.on('recognition_result', function(data) {
        if (data.recognized_text && data.translated_text) {
            const language = detectLanguage(data.recognized_text);
            addChatMessage(data.recognized_text, data.translated_text, data.generated_context, language);
        }
    });

    socket.on('status', function(data) {
        console.log(data.status);
    });

    socket.on('error', function(data) {
        console.error(data.error);
    });

    // Function to detect the speaking language, generate by ChatGPT
    function detectLanguage(text) {
        const hasChineseCharacters = /[\u3400-\u9FBF]/;
        return hasChineseCharacters.test(text) ? 'Chinese' : 'English';
    }

    // Function to add the message to the chat window, part of generated by chatGPT
    function addChatMessage(recognizedText, translatedText, generatedText, language) {
        localStorage.removeItem('conversation');
        
        const chatContainer = document.querySelector('.chat');
        if (chatContainer) {
            chatContainer.innerHTML = '';
        } else {
            console.error('Cannot find the chat Container');
        }

        // Create a chatBox, to include the translation and recognisation langauge 
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message-container');

        // Handle the recognition language
        const languageMessage = document.createElement('div');
        languageMessage.classList.add('message', 'language');
        const speakIcon = document.createElement('i');
        speakIcon.className = 'bi bi-megaphone-fill';
        languageMessage.appendChild(speakIcon);
        languageMessage.append(' Recognised: ' + language);  
        messageContainer.appendChild(languageMessage);

        const userMessage = document.createElement('div');
        userMessage.classList.add('message', 'user');
        userMessage.textContent = recognizedText;
        messageContainer.appendChild(userMessage);

        // Handle the translation language
        const translationLanguageMessage = document.createElement('div');
        translationLanguageMessage.classList.add('message', 'language');
        const translateIcon = document.createElement('i');
        translateIcon.className = 'bi bi-translate';
        translationLanguageMessage.appendChild(translateIcon);
        translationLanguageMessage.append(' Translation: ' + (language === 'Chinese' ? 'English' : 'Chinese'));  
        messageContainer.appendChild(translationLanguageMessage);

        const botMessage = document.createElement('div');
        botMessage.classList.add('message', 'translation');
        botMessage.textContent = translatedText;
        messageContainer.appendChild(botMessage);

        // Handle the generated context
        const bMessage = document.createElement('div');
        bMessage.classList.add('message', 'generated');
        bMessage.textContent = 'Context: ' + generatedText;
        messageContainer.appendChild(bMessage);

        chatContainer.appendChild(messageContainer);
        chatContainer.scrollTop = chatWindow.scrollHeight;
        }
    });

    // Clear function button, generate by ChatGPT
        document.getElementById('clearConversation').addEventListener('click', function() {
        localStorage.removeItem('conversation');

        const chatContainer = document.querySelector('.chat');
        if (chatContainer) {
            chatContainer.innerHTML = '';  
        } else {
            console.error('Cannot find the chat Container');
        }
    });

    // Select senario, and display the selected one, generate by ChatGPT
    document.getElementById('scenario').addEventListener('click', function() {
        var dropdownMenu = document.getElementById('select_menu');
        var button = this;

        dropdownMenu.classList.toggle('show');
        button.classList.toggle('active');
    });

    window.onclick = function(event) {
        if (!event.target.matches('#scenario')) {
            var dropdownMenu = document.getElementById('select_menu');
            var button = document.getElementById('scenario');

            if (dropdownMenu.classList.contains('show')) {
                dropdownMenu.classList.remove('show');
                button.classList.remove('active');
            }
        }
    };

    // Change the select option front size, generate by ChatGPT
    document.querySelectorAll('#select_menu a').forEach(function(item) {
    item.addEventListener('click', function() {
        var button = document.getElementById('scenario');
        button.textContent = this.textContent; 
        
        button.style.width = ""; 
        button.style.width = button.scrollWidth + "px";

        button.classList.remove('active');
        document.getElementById('select_menu').classList.remove('show');
        });
    });
</script>

{% endblock %}
